<html>
<head>
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css" integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" crossorigin="anonymous">
<style>

html, body {
    font-size: 20px;
    font-family: 'Unify Serif', serif;
    color: #434343;
}

section {
    max-width: 550px;
    margin: 0 auto;
}

p {
    line-height: 1.4;
}

.hidden {
    display: none;
}

.graphic {
    font-family: 'Unify Sans', sans-serif;
    margin: 40px auto;
}

.graphic .title {
    font-size: 22px;
    font-weight: bold;
    color: #222;
    margin-bottom: 5px;
}

.graphic .subtitle {
    font-size: 18px;
    color: #666;
    margin-bottom: 10px;
}

select {
    display: inline-block;
    height: calc(2.25rem + 2px);
    padding: 0.375rem 1.75rem 0.375rem 0.75rem;
    line-height: 1.5;
    color: #fff;
    vertical-align: middle;
    background: steelblue;
    border: none;
    border-radius: 0.25rem;
    appearance: none;
    font-size: 1rem;
    color: #222;
}

button {
    height: calc(2.25rem + 2px);
    padding: 0.3rem 0.6rem 0.3rem 0.6rem;
    line-height: 1.5;
    vertical-align: middle;
    background: hsla(203, 50%, 87%);
    border: none;
    border-radius: 0.25rem;
    font-size: 1rem;
    color: hsla(203, 60%, 32%);
    font-weight: bold;
    outline: 0;
    cursor: pointer;
    box-shadow: 0px 4px 6px hsla(0, 0%, 0%, 0.2);
}

button:hover {
    background: hsla(203, 50%, 90%);
    color: hsla(203, 60%, 25%);
}

</style>
</head>
<body>
<section>
    <p>Spicy jalapeno bacon ipsum dolor amet beef turducken shankle, strip steak pork belly kielbasa ham hock porchetta filet mignon landjaeger burgdoggen swine. Hamburger drumstick jerky, strip steak brisket salami pastrami t-bone chuck venison rump prosciutto picanha tenderloin. Brisket flank ham tenderloin bresaola bacon pig burgdoggen, turkey meatball meatloaf frankfurter tri-tip. Pastrami chicken picanha doner, ham hock swine ball tip ribeye pork belly bacon cow strip steak andouille.</p>
    <p>Beef ribs picanha swine burgdoggen meatball. Kielbasa pancetta tail, sausage tongue fatback turkey jerky pig alcatra short loin pastrami cow. Bresaola frankfurter kielbasa porchetta shank, short loin hamburger. Chicken pastrami filet mignon, beef ribs pork belly tenderloin shoulder pork chop meatball strip steak pancetta rump drumstick.</p>
    <p>Tail ball tip andouille, spare ribs t-bone beef cow shank. T-bone bresaola buffalo salami short ribs, strip steak pig flank alcatra ball tip. Pancetta porchetta cupim spare ribs venison kevin ground round short ribs turducken ribeye turkey rump. Shank biltong strip steak pork chop. Pig tenderloin spare ribs shankle, chicken corned beef doner t-bone pancetta shank. Corned beef landjaeger pork venison.</p>
    <p>Ground round jerky shank leberkas kielbasa tenderloin fatback tail kevin alcatra flank salami. Shank pork prosciutto turkey sausage porchetta. Drumstick sausage tenderloin bresaola pastrami jowl. Sausage jowl kielbasa, chicken porchetta filet mignon ham hock jerky prosciutto t-bone pork chop meatball shank flank burgdoggen. Tenderloin turducken cupim tail pork loin spare ribs frankfurter, porchetta beef ribs.</p>        
</section>
<div class="graphic">
    <div class="title">
        Lorem ipsum
    </div>
    <div class="subtitle">
        Dolor sit amet
    </div>
    <svg></svg>
</div>
<section>
    <p>Boudin pork loin pastrami shank sausage hamburger chicken turkey shankle. Leberkas jowl ham hock frankfurter kielbasa. Turducken ribeye biltong, hamburger prosciutto andouille chicken. Pork cow andouille brisket. Shank bresaola beef ribs, chuck filet mignon rump hamburger chicken landjaeger boudin pastrami salami sirloin andouille fatback. Sausage buffalo tail picanha jowl.</p>
    <p>Drumstick tongue rump buffalo spare ribs meatloaf. Meatloaf pig short ribs filet mignon shankle pastrami. Shankle tongue pork loin spare ribs sirloin prosciutto andouille cow pork chop short ribs. Ribeye tenderloin beef ribs pork belly salami ball tip pork boudin drumstick meatloaf. Leberkas boudin frankfurter tongue buffalo pork loin.        </p>
    <p>Tri-tip fatback turkey bresaola pork pig capicola tongue tenderloin. Beef ribs burgdoggen venison, t-bone alcatra pancetta beef ground round cow drumstick. Turducken shank porchetta, chuck meatball strip steak jowl ball tip capicola brisket pork loin pig drumstick cupim. Jerky salami ground round turducken kevin short ribs chuck landjaeger doner sirloin, brisket strip steak corned beef t-bone. Boudin kielbasa tri-tip salami venison drumstick. Pork chop kevin ham hock meatball biltong leberkas spare ribs turducken turkey pig boudin jowl frankfurter pork tongue. Capicola flank sirloin kielbasa t-bone, venison beef cow meatball alcatra.</p>
    <p>Boudin kielbasa tenderloin capicola sirloin tri-tip. Ribeye hamburger rump pork belly tenderloin, leberkas sirloin ball tip t-bone flank ham hock. Porchetta pastrami filet mignon salami drumstick, pork belly short ribs brisket buffalo meatball corned beef bacon short loin frankfurter. Doner brisket picanha, prosciutto strip steak chuck flank. Brisket bacon t-bone pork.</p>
</section>

<script src="https://d3js.org/d3.v5.min.js"></script>
<script>

const parseDate = d3.timeParse('%Y-%m-%d');
const parseMonthDay = d3.timeParse('%m-%d');

const formatDate = d3.timeFormat('%Y-%m-%d');

const winterMonths = [10, 11, 12, 1, 2, 3, 4];

const margin = {top: 10, right: 10, bottom: 30, left: 30};
const fullWidth = 960;
const fullHeight = 600;
const width = fullWidth - margin.left - margin.right;
const height = fullHeight - margin.top - margin.bottom;

const years = d3.range(1939, 2019);

const stack = d3.stack()
    .keys(years);

const colorScale = d3.scaleThreshold()
    .domain([1940, 1950, 1960, 1970, 1980, 1990, 2000, 2010])
    .range(['#fff7f3', '#fde0dd', '#fcc5c0', '#fa9fb5', '#f768a1', '#dd3497', '#ae017e', '#7a0177', '#49006a']);

const xScale = d3.scaleBand()
    .range([0, width]);

function xAxis(g) {
    const axis = d3.axisBottom(xScale);

    g.call(axis);

    g.selectAll('.tick')
        .each(function(d) {
            const date = parseDate(d);
            if (date.getDate() === 1) {
                const month = d3.timeFormat('%B')(date);
                d3.select(this)
                    .select('text')
                    .text(month);
            } else {
                d3.select(this).remove();
            }
            
        });
}

const yScale = d3.scaleLinear()
    .range([height, 0]);

const yAxis = d3.axisLeft(yScale);

const container = d3.select('.graphic');

container
    .style('width', `${fullWidth}px`);

const svg = d3.select('svg')
    .attr('width', fullWidth)
    .attr('height', fullHeight);

const g = svg.append('g')
    .attr('transform', `translate(${margin.left}, ${margin.top})`);

function ready(raw) {
    const data = raw
        .filter(d => d.element === 'SNOW')
        .map((d) => {
            const date = parseDate(d.date);
            const year = date.getFullYear();
            const day = d3.timeFormat('%m-%d')(date);
            const snowfall = (+d.value) / 25.4;
            return {date, year, day, snowfall};
        })
        .filter(d => winterMonths.indexOf(d.date.getMonth() + 1) > -1)

    const grouped = d3.nest()
        .key(d => d.day)
        .entries(data)
        .map((group) => {
            const day = group.key;
            const target = {day};
            const source = group.values
                .map(d => ({key: d.year, value: d.snowfall}))
                .reduce((a, b) => { a[b.key] = b.value; return a; }, {});
            return Object.assign(target, source);
        });
    
    // [
    //     [[0, 10 (for Apr 1)], [0, 12(for Apr 2)], ...], 1939
    //     [...], 1940
    //     [...], 1941
    //     ...
    // ]

    const stacked = stack(grouped)
        .map((year) => {
            const days = year.map((d) => {
                const date = parseMonthDay(d.data.day);
                if (date.getMonth() < 9) date.setFullYear(date.getFullYear() + 1);
                return {
                    date: formatDate(date),
                    year: year.key,
                    start: d[0],
                    end: d[1],
                };
            });
            return {year: year.key, days};
        });
    
    let xDomain = stacked[0].days.map(d => parseDate(d.date));
    xDomain.sort((a, b) => a - b);
    xDomain = xDomain.map(d => formatDate(d));

    xScale.domain(xDomain);

    const yMax = d3.max(
        stacked
            .map(year => year.days.map(day => day.end))
            .reduce((a, b) => a.concat(b), [])
    );

    yScale.domain([0, yMax]);

    g.append('g')
        .attr('class', 'axis axis--x')
        .attr('transform', `translate(0, ${height})`)
        .call(xAxis);

    g.append('g')
        .attr('class', 'axis axis--y')
        .call(yAxis);

    const year = g.append('g').attr('class', 'years')
            .selectAll('.year').data(stacked)
        .enter().append('g')
            .attr('class', d => `year year--${d.year}`);
    
    const day = year.selectAll('.day').data(d => d.days)
        .enter().append('g')
            .attr('class', d => `day day--${d.date}`)
            .attr('transform', (d) => {
                const tx = xScale(d.date);
                const ty = d.end ? yScale(d.end) : 0;
                return `translate(${tx}, ${ty})`;
            });

    day.append('rect')
        .attr('width', xScale.bandwidth())
        .attr('height', (d) => {
            return d.end ? (yScale(d.start) - yScale(d.end)) : 0;
        })
        .style('fill', d => colorScale(d.year));
}

d3.csv('mke-weather.csv')
    .then(ready);

</script>
</body>
</html>