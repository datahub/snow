<html>
<head>
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css" integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" crossorigin="anonymous">
<style>

html, body {
    font-size: 20px;
    font-family: 'Unify Serif', serif;
    color: #434343;
}

section {
    max-width: 550px;
    margin: 0 auto;
}

p {
    line-height: 1.4;
}

.hidden {
    display: none;
}

.graphic {
    font-family: 'Unify Sans', sans-serif;
    margin: 40px auto;
}

.graphic .title {
    font-size: 22px;
    font-weight: bold;
    color: #222;
    margin-bottom: 5px;
}

.graphic .subtitle {
    font-size: 18px;
    color: #666;
    margin-bottom: 10px;
}

.layers {
    position: relative;
}

svg {
    position: absolute;
    left: 0;
    top: 0;
}

.html-layer {
    position: absolute;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
}

.html-layer.no-mouse {
    pointer-events: none;
}

.axis--y .domain {
    display: none;
}

.axis .tick text {
    fill: #666;
    font-size: 16px;
    font-family: 'Unify Sans', sans-serif;
}

.axis-title {
    font-size: 14px;
    font-family: 'Unify Sans', sans-serif;
    font-weight: bold;
    fill: #434343;
}

.season path {
    fill: none;
    stroke: #ddd;
}

.season circle {
    opacity: 0;
    fill: steelblue;
}

.season text {
    opacity: 0;
    fill: steelblue;
    font-size: 16px;
    text-shadow: 1px 1px 1px #fff,
                 2px 1px 1px #fff,
                 1px 2px 1px #fff,
                 2px 2px 1px #fff;
}

.season.highlight path {
    opacity: 0.6;
    stroke: steelblue;
    stroke-width: 2px;
}

.season.highlight circle {
    opacity: 0.6;
}

.season.highlight text {
    opacity: 0.85;
}

.season.active path {
    opacity: 1;
    stroke: steelblue;
    stroke-width: 2px;
}

.season.active circle {
    opacity: 1;
}

.season.active text {
    opacity: 1;
}

.hover-rect {
    fill: #fff;
    opacity: 0;
    transition: opacity 0.5s;
}

.hover-rect.opaque {
    opacity: 0.65;
}

select {
    display: inline-block;
    height: calc(2.25rem + 2px);
    padding: 0.375rem 1.75rem 0.375rem 0.75rem;
    line-height: 1.5;
    color: #fff;
    vertical-align: middle;
    background: steelblue;
    border: none;
    border-radius: 0.25rem;
    appearance: none;
    font-size: 1rem;
    color: #222;
}

button {
    height: calc(2.25rem + 2px);
    padding: 0.3rem 0.6rem 0.3rem 0.6rem;
    line-height: 1.5;
    vertical-align: middle;
    background: hsla(203, 50%, 87%);
    border: none;
    border-radius: 0.25rem;
    font-size: 1rem;
    color: hsla(203, 60%, 32%);
    font-weight: bold;
    outline: 0;
    cursor: pointer;
    box-shadow: 0px 4px 6px hsla(0, 0%, 0%, 0.2);
}

button:hover {
    background: hsla(203, 50%, 90%);
    color: hsla(203, 60%, 25%);
}

.or-separator {
    padding: 0px 5px;
}

.call-to-action {
    position: absolute;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%);
}

#year-select-box {
    display: none;
}

</style>
</head>
<body>
<section>
    <p>Spicy jalapeno bacon ipsum dolor amet beef turducken shankle, strip steak pork belly kielbasa ham hock porchetta filet mignon landjaeger burgdoggen swine. Hamburger drumstick jerky, strip steak brisket salami pastrami t-bone chuck venison rump prosciutto picanha tenderloin. Brisket flank ham tenderloin bresaola bacon pig burgdoggen, turkey meatball meatloaf frankfurter tri-tip. Pastrami chicken picanha doner, ham hock swine ball tip ribeye pork belly bacon cow strip steak andouille.</p>
    <p>Beef ribs picanha swine burgdoggen meatball. Kielbasa pancetta tail, sausage tongue fatback turkey jerky pig alcatra short loin pastrami cow. Bresaola frankfurter kielbasa porchetta shank, short loin hamburger. Chicken pastrami filet mignon, beef ribs pork belly tenderloin shoulder pork chop meatball strip steak pancetta rump drumstick.</p>
    <p>Tail ball tip andouille, spare ribs t-bone beef cow shank. T-bone bresaola buffalo salami short ribs, strip steak pig flank alcatra ball tip. Pancetta porchetta cupim spare ribs venison kevin ground round short ribs turducken ribeye turkey rump. Shank biltong strip steak pork chop. Pig tenderloin spare ribs shankle, chicken corned beef doner t-bone pancetta shank. Corned beef landjaeger pork venison.</p>
    <p>Ground round jerky shank leberkas kielbasa tenderloin fatback tail kevin alcatra flank salami. Shank pork prosciutto turkey sausage porchetta. Drumstick sausage tenderloin bresaola pastrami jowl. Sausage jowl kielbasa, chicken porchetta filet mignon ham hock jerky prosciutto t-bone pork chop meatball shank flank burgdoggen. Tenderloin turducken cupim tail pork loin spare ribs frankfurter, porchetta beef ribs.</p>        
</section>
<div class="graphic">
    <div class="title">
        2018 snowfall compared to years past
    </div>
    <div class="subtitle">
        Snow accumulation for every winter season in Milwaukee since 1939
    </div>
    <select id="year-select-box"></select>
    <div class="layers">
        <svg></svg>
        <div class="html-layer">
            <div class="call-to-action">
                <button id="take-tour">
                    Take a tour
                </button>
                <span class="or-separator">or</span>
                <button id="explore">
                    Explore
                </button>
            </div>
        </div>
    </div>
</div>
<section>
    <p>Boudin pork loin pastrami shank sausage hamburger chicken turkey shankle. Leberkas jowl ham hock frankfurter kielbasa. Turducken ribeye biltong, hamburger prosciutto andouille chicken. Pork cow andouille brisket. Shank bresaola beef ribs, chuck filet mignon rump hamburger chicken landjaeger boudin pastrami salami sirloin andouille fatback. Sausage buffalo tail picanha jowl.</p>
    <p>Drumstick tongue rump buffalo spare ribs meatloaf. Meatloaf pig short ribs filet mignon shankle pastrami. Shankle tongue pork loin spare ribs sirloin prosciutto andouille cow pork chop short ribs. Ribeye tenderloin beef ribs pork belly salami ball tip pork boudin drumstick meatloaf. Leberkas boudin frankfurter tongue buffalo pork loin.        </p>
    <p>Tri-tip fatback turkey bresaola pork pig capicola tongue tenderloin. Beef ribs burgdoggen venison, t-bone alcatra pancetta beef ground round cow drumstick. Turducken shank porchetta, chuck meatball strip steak jowl ball tip capicola brisket pork loin pig drumstick cupim. Jerky salami ground round turducken kevin short ribs chuck landjaeger doner sirloin, brisket strip steak corned beef t-bone. Boudin kielbasa tri-tip salami venison drumstick. Pork chop kevin ham hock meatball biltong leberkas spare ribs turducken turkey pig boudin jowl frankfurter pork tongue. Capicola flank sirloin kielbasa t-bone, venison beef cow meatball alcatra.</p>
    <p>Boudin kielbasa tenderloin capicola sirloin tri-tip. Ribeye hamburger rump pork belly tenderloin, leberkas sirloin ball tip t-bone flank ham hock. Porchetta pastrami filet mignon salami drumstick, pork belly short ribs brisket buffalo meatball corned beef bacon short loin frankfurter. Doner brisket picanha, prosciutto strip steak chuck flank. Brisket bacon t-bone pork.</p>
</section>

<script src="https://d3js.org/d3.v5.min.js"></script>
<script>

const parseDate = d3.timeParse('%Y-%m-%d');

const formatMonth = (date) => {
    const month = date.getMonth();
    const abbreviatedMonths = [0, 1, 7, 8, 9, 10, 11];
    const isAbbreviated = abbreviatedMonths.indexOf(month) > -1;
    if (isAbbreviated) return `${d3.timeFormat('%b')(date)}.`;
    return d3.timeFormat('%B')(date);
};

let defaultYear = '2018';

const margin = {top: 30, right: 40, bottom: 30, left: 50};
const fullWidth = 800;
const fullHeight = 500;
const width = fullWidth - margin.left - margin.right;
const height = fullHeight - margin.top - margin.bottom;

const graphic = d3.select('.graphic')
    .style('max-width', `${width}px`);

const layers = graphic.select('.layers')
    .style('width', `${fullWidth}px`)
    .style('height', `${fullHeight}px`);

const htmlLayer = layers.select('.html-layer');

const svg = layers.select('svg')
    .attr('width', fullWidth)
    .attr('height', fullHeight);

const g = svg.append('g')
    .attr('transform', `translate(${margin.left}, ${margin.top})`);

const hoverRect = svg.append('rect')
    .attr('class', 'hover-rect')
    .attr('x', 0)
    .attr('y', 0)
    .attr('width', fullWidth)
    .attr('height', fullHeight)
    .classed('opaque', true);

const selectBox = graphic.select('#year-select-box');

const callToAction = graphic.select('.call-to-action');
const takeTourButton = callToAction.select('#take-tour');
const exploreButton = callToAction.select('#explore');
const orSeparator = callToAction.select('.or-separator');

const xAccessor = d => d.date;

const xScale = d3.scaleTime()
    .range([0, width]);

function xAxis(g) {
    const axis = d3.axisBottom(xScale)
        .tickFormat(formatMonth);
    
    g.call(axis);

    g.selectAll('.tick text')
        .attr('text-anchor', 'start')
        .attr('dx', 5)
        .attr('y', 5);

    g.selectAll('.tick line')
        .attr('y2', 18);
}

const xValue = (d) => {
    const month = xAccessor(d).getMonth();
    const year = month > 4 ? 2001 : 2002;
    const day = xAccessor(d).getDate();
    const date = new Date(year, month, day);
    return xScale(date);
};

const yAccessor = d => d.accumulation;

const yScale = d3.scaleLinear()
    .range([height, 0]);


function yAxis(g) {
    const axis = d3.axisLeft(yScale);

    g.call(axis);

    g.append('text')
        .attr('class', 'axis-title')
        .attr('x', 0)
        .attr('y', 20)
        .text('Inches');
}

const yValue = (d) => {
    return yScale(yAccessor(d));
};

const drawLine = d3.line()
    .x(xValue)
    .y(yValue);

const tree = d3.quadtree()
    .x(xValue)
    .y(yValue)
    .extent([[-margin.left, -margin.top], [fullWidth, fullHeight]]);

function row(d) {
    return {
        date: parseDate(d.date),
        season: +d.winter_year,
        accumulation: (+d.snow_accumulation) / 25.4,
    };
}

function explore() {
    callToAction.classed('hidden', true);
    hoverRect.classed('opaque', false);
    htmlLayer.classed('no-mouse', true);
}

function takeTour() {
    callToAction.classed('hidden', true);
    hoverRect.classed('opaque', false);
    htmlLayer.classed('no-mouse', true);
}

function ready(data) {
    data = data
        .filter(d => d.season !== 1937)
        .filter(d => d.season !== 1939);

    xScale.domain([new Date(2001, 9, 1), new Date(2002, 3, 30)]);
    yScale.domain([0, d3.max(data, yAccessor)]);

    tree.addAll(data);

    const bySeason = d3.nest()
        .key(d => d.season)
        .entries(data);

    const seasons = g.append('g').attr('class', 'seasons');

    const season = seasons.selectAll('.season').data(bySeason)
        .enter().append('g')
            .attr('class', d => `season season--${d.key}`);
        
    season.append('path')
        .datum(d => d.values)
        .attr('d', drawLine);
    
    season.append('circle')
        .datum(d => d.values.slice(-1)[0])
        .attr('transform', d => `translate(${xValue(d)}, ${yValue(d)})`)
        .attr('r', 4);
    
    season.append('text')
        .datum(d => d.values.slice(-1)[0])
        .attr('transform', d => `translate(${xValue(d)}, ${yValue(d)})`)
        .attr('text-anchor', 'middle')
        .attr('dy', '-0.67em')
        .html((d) => {
            const y0 = d.season;
            const y1 = (y0 + 1).toString().slice(-2);
            return `${y0}&ndash;${y1}`;
        });

    g.append('g')
        .attr('class', 'axis axis--x')
        .attr('transform', `translate(0, ${height})`)
        .call(xAxis);
    
    g.append('g')
        .attr('class', 'axis axis--y')
        .call(yAxis);

    function activate(year) {
        season.classed('active', false);
        season
            .filter(d => d.key === year)
            .classed('active', true)
            .raise();
    }

    function highlight(year) {
        season.classed('highlight', false);
        season
            .filter(d => d.key === year)
            .classed('highlight', true)
            .raise();
        activate(defaultYear);
    }

    activate(defaultYear);

    const defaultOption = {selected: true, text: 'Select a winter season...'};

    const seasonOptions = bySeason
        .map(d => {
            const thisYear = +d.key;
            const nextYearAbbrev = (thisYear + 1).toString().slice(-2);
            return {
                value: thisYear,
                text: `${thisYear}-${nextYearAbbrev}`,
            };
        });
    
    seasonOptions.sort((a, b) => {
        const y0 = +a.value;
        const y1 = +b.value;
        return y1 - y0;
    });

    const optionData = [defaultOption].concat(seasonOptions);

    const option = selectBox.selectAll('option').data(optionData)
        .enter().append('option')
            .attr('selected', d => d.selected)
            .attr('value', d => d.value)
            .text(d => d.text);

    function changeSeason(d) {
        const i = selectBox.node().selectedIndex;
        const selectedOption = selectBox.node().options[i];
        defaultYear = selectedOption.value;
        activate(defaultYear);
        highlight(false);
    }

    selectBox.on('change', changeSeason);

    function mouseenter() {
        const [mx, my] = d3.mouse(this);
        const x = mx - margin.left;
        const y = my - margin.top;
        const d = tree.find(x, y);
        const season = d.season.toString();
        highlight(season);
    }

    function mousemove() {
        const [mx, my] = d3.mouse(this);
        const x = mx - margin.left;
        const y = my - margin.top;
        const d = tree.find(x, y);
        const season = d.season.toString();
        highlight(season);
    }

    function mouseleave() {
        highlight(defaultYear);
    }

    hoverRect
        .on('mouseenter', mouseenter)
        .on('mousemove', mousemove)
        .on('mouseleave', mouseleave);

    exploreButton.on('click', explore);
    takeTourButton.on('click', takeTour);
}

d3.csv('snow-accumulation.csv', row)
    .then(ready);

</script>
</body>
</html>